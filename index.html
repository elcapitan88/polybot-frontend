<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Polymarket Spread Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .card {
            @apply bg-white rounded-lg shadow-md p-6;
        }
        .stat-value {
            @apply text-3xl font-bold text-gray-800;
        }
        .stat-label {
            @apply text-sm text-gray-500 uppercase tracking-wide;
        }
        .badge-btc { @apply bg-orange-100 text-orange-800; }
        .badge-eth { @apply bg-blue-100 text-blue-800; }
        .badge-xrp { @apply bg-gray-100 text-gray-800; }
        .badge-sol { @apply bg-purple-100 text-purple-800; }
        .opportunity-glow {
            animation: glow 1s ease-in-out infinite alternate;
        }
        @keyframes glow {
            from { box-shadow: 0 0 5px #22c55e, 0 0 10px #22c55e; }
            to { box-shadow: 0 0 10px #22c55e, 0 0 20px #22c55e; }
        }
        .spread-card {
            transition: all 0.3s ease;
        }
        .spread-card.has-opportunity {
            @apply border-2 border-green-500 bg-green-50;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">Polymarket Spread Monitor</h1>
                <p class="text-gray-500">Delta-Neutral Strategy: Buy UP + DOWN when combined &lt; $1.00</p>
            </div>
            <div class="flex items-center gap-6">
                <!-- Resolution Countdown -->
                <div class="text-center">
                    <div class="text-xs text-gray-500 uppercase">Next Resolution</div>
                    <div id="countdown" class="text-lg font-bold text-blue-600">--:--</div>
                </div>
                <!-- Connection Status -->
                <div class="text-center">
                    <div id="monitor-status" class="flex items-center gap-2">
                        <span class="w-3 h-3 rounded-full bg-gray-400"></span>
                        <span class="text-gray-500">Connecting...</span>
                    </div>
                    <div class="text-xs text-gray-400" id="ws-messages">-</div>
                </div>
                <div class="text-sm text-gray-500" id="last-update">-</div>
            </div>
        </div>

        <!-- Live Spreads Grid -->
        <div class="mb-8">
            <h2 class="text-xl font-semibold mb-4">Live Spreads</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4" id="spreads-grid">
                <!-- Spread cards will be inserted here -->
                <div class="card text-center text-gray-400">Loading...</div>
            </div>
        </div>

        <!-- Stats Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-8">
            <div class="card">
                <div class="stat-label">Markets Tracked</div>
                <div class="stat-value" id="stat-markets">-</div>
            </div>
            <div class="card">
                <div class="stat-label">Active Opportunities</div>
                <div class="stat-value text-green-600" id="stat-active">0</div>
            </div>
            <div class="card">
                <div class="stat-label">Last Hour</div>
                <div class="stat-value text-blue-600" id="stat-hour">-</div>
            </div>
            <div class="card">
                <div class="stat-label">Last 24h</div>
                <div class="stat-value" id="stat-24h">-</div>
            </div>
            <div class="card">
                <div class="stat-label">Best Spread (24h)</div>
                <div class="stat-value text-green-600" id="stat-best">-</div>
            </div>
        </div>

        <!-- Charts and Active Opportunities -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- Active Opportunities -->
            <div class="card">
                <h2 class="text-xl font-semibold mb-4">Active Opportunities</h2>
                <div id="active-opportunities" class="space-y-3">
                    <p class="text-gray-400 text-center py-8">No active opportunities</p>
                </div>
            </div>

            <!-- Hourly Chart -->
            <div class="card">
                <h2 class="text-xl font-semibold mb-4">Opportunities by Hour (24h)</h2>
                <canvas id="hourly-chart" height="200"></canvas>
            </div>
        </div>

        <!-- By Asset Stats -->
        <div class="card mb-8">
            <h2 class="text-xl font-semibold mb-4">Opportunities by Asset (24h)</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="asset-stats">
                <div class="text-center p-4 bg-orange-50 rounded-lg">
                    <div class="text-2xl font-bold text-orange-600" id="asset-btc">-</div>
                    <div class="text-sm text-gray-600">BTC</div>
                </div>
                <div class="text-center p-4 bg-blue-50 rounded-lg">
                    <div class="text-2xl font-bold text-blue-600" id="asset-eth">-</div>
                    <div class="text-sm text-gray-600">ETH</div>
                </div>
                <div class="text-center p-4 bg-purple-50 rounded-lg">
                    <div class="text-2xl font-bold text-purple-600" id="asset-sol">-</div>
                    <div class="text-sm text-gray-600">SOL</div>
                </div>
                <div class="text-center p-4 bg-gray-50 rounded-lg">
                    <div class="text-2xl font-bold text-gray-600" id="asset-xrp">-</div>
                    <div class="text-sm text-gray-600">XRP</div>
                </div>
            </div>
        </div>

        <!-- Recent Opportunities Table -->
        <div class="card">
            <h2 class="text-xl font-semibold mb-4">Recent Opportunities</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-2 text-left">Time</th>
                            <th class="px-4 py-2 text-left">Asset</th>
                            <th class="px-4 py-2 text-right">UP Price</th>
                            <th class="px-4 py-2 text-right">DOWN Price</th>
                            <th class="px-4 py-2 text-right">Combined</th>
                            <th class="px-4 py-2 text-right">Spread %</th>
                            <th class="px-4 py-2 text-right">Duration</th>
                            <th class="px-4 py-2 text-right">Max Size</th>
                        </tr>
                    </thead>
                    <tbody id="opportunities-table">
                        <tr><td colspan="8" class="text-center py-8 text-gray-400">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Backend API URL
        const API_BASE = window.location.hostname === 'localhost'
            ? 'http://localhost:8000'
            : 'https://polybot-misc.up.railway.app';

        let hourlyChart = null;

        // Calculate next 15-minute resolution time
        function getNextResolution() {
            const now = new Date();
            const minutes = now.getMinutes();
            const nextQuarter = Math.ceil((minutes + 1) / 15) * 15;
            const next = new Date(now);
            if (nextQuarter >= 60) {
                next.setHours(next.getHours() + 1);
                next.setMinutes(0);
            } else {
                next.setMinutes(nextQuarter);
            }
            next.setSeconds(0);
            next.setMilliseconds(0);
            return next;
        }

        // Update countdown display
        function updateCountdown() {
            const next = getNextResolution();
            const now = new Date();
            const diff = Math.max(0, Math.floor((next - now) / 1000));
            const mins = Math.floor(diff / 60);
            const secs = diff % 60;
            const countdownEl = document.getElementById('countdown');
            countdownEl.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;

            // Flash when close to resolution
            if (diff <= 30) {
                countdownEl.classList.add('text-red-600', 'animate-pulse');
                countdownEl.classList.remove('text-blue-600');
            } else {
                countdownEl.classList.remove('text-red-600', 'animate-pulse');
                countdownEl.classList.add('text-blue-600');
            }
        }

        // Start countdown timer
        setInterval(updateCountdown, 1000);
        updateCountdown();

        // Format timestamp
        function formatTime(isoString) {
            if (!isoString) return '-';
            const date = new Date(isoString);
            return date.toLocaleTimeString();
        }

        // Format price
        function formatPrice(price) {
            if (price === null || price === undefined) return '-';
            return '$' + price.toFixed(3);
        }

        // Format duration
        function formatDuration(seconds) {
            if (!seconds) return '-';
            if (seconds < 60) return seconds.toFixed(1) + 's';
            return (seconds / 60).toFixed(1) + 'm';
        }

        // Get asset badge class
        function assetBadge(asset) {
            const classes = {
                'BTC': 'badge-btc',
                'ETH': 'badge-eth',
                'XRP': 'badge-xrp',
                'SOL': 'badge-sol'
            };
            return `<span class="px-2 py-1 rounded text-xs font-medium ${classes[asset] || 'bg-gray-100'}">${asset}</span>`;
        }

        // Get spread color class
        function getSpreadColor(spreadPct) {
            if (spreadPct > 2) return 'text-green-600';
            if (spreadPct > 1) return 'text-green-500';
            if (spreadPct > 0) return 'text-yellow-600';
            return 'text-gray-600';
        }

        // Load monitor status and summary
        async function loadSummary() {
            try {
                const res = await fetch(`${API_BASE}/api/stats/summary`);
                const data = await res.json();

                if (data.error) {
                    document.getElementById('monitor-status').innerHTML =
                        '<span class="w-3 h-3 rounded-full bg-red-500"></span><span class="text-red-500">Error</span>';
                    return;
                }

                // Monitor status
                const statusEl = document.getElementById('monitor-status');
                if (data.monitor?.markets_closed) {
                    statusEl.innerHTML = '<span class="w-3 h-3 rounded-full bg-orange-500"></span><span class="text-orange-600">Markets Closed</span>';
                } else if (data.monitor?.connected) {
                    statusEl.innerHTML = '<span class="w-3 h-3 rounded-full bg-green-500 animate-pulse"></span><span class="text-green-600">WebSocket Live</span>';
                } else {
                    statusEl.innerHTML = '<span class="w-3 h-3 rounded-full bg-yellow-500"></span><span class="text-yellow-600">Connecting...</span>';
                }

                // WebSocket message count
                const msgCount = data.monitor?.messages_received || 0;
                document.getElementById('ws-messages').textContent = msgCount > 0 ? `${msgCount.toLocaleString()} msgs` : '-';

                // Stats
                document.getElementById('stat-markets').textContent = data.monitor?.markets_tracked || '-';
                document.getElementById('stat-active').textContent = data.monitor?.active_opportunities || '0';
                document.getElementById('stat-hour').textContent = data.last_hour?.opportunities || '0';
                document.getElementById('stat-24h').textContent = data.last_24h?.opportunities || '0';
                document.getElementById('stat-best').textContent = data.last_24h?.best_spread_pct ?
                    data.last_24h.best_spread_pct.toFixed(2) + '%' : '-';

                // By asset
                if (data.last_24h?.by_asset) {
                    document.getElementById('asset-btc').textContent = data.last_24h.by_asset.BTC || 0;
                    document.getElementById('asset-eth').textContent = data.last_24h.by_asset.ETH || 0;
                    document.getElementById('asset-sol').textContent = data.last_24h.by_asset.SOL || 0;
                    document.getElementById('asset-xrp').textContent = data.last_24h.by_asset.XRP || 0;
                }

                // Best current opportunity
                const activeEl = document.getElementById('active-opportunities');
                if (data.best_current) {
                    const o = data.best_current;
                    activeEl.innerHTML = `
                        <div class="p-4 bg-green-100 rounded-lg border-2 border-green-500 opportunity-glow">
                            <div class="flex justify-between items-center">
                                <div>
                                    ${assetBadge(o.asset)}
                                    <span class="ml-2 text-sm text-gray-600">${o.timeframe}</span>
                                </div>
                                <div class="text-2xl font-bold text-green-600">${o.spread_pct?.toFixed(2)}%</div>
                            </div>
                            <div class="mt-2 grid grid-cols-3 gap-2 text-sm">
                                <div>
                                    <span class="text-gray-500">UP:</span>
                                    <span class="font-medium">${formatPrice(o.up_price || o.up_ask)}</span>
                                </div>
                                <div>
                                    <span class="text-gray-500">DOWN:</span>
                                    <span class="font-medium">${formatPrice(o.down_price || o.down_ask)}</span>
                                </div>
                                <div>
                                    <span class="text-gray-500">Combined:</span>
                                    <span class="font-bold text-green-600">${formatPrice(o.combined)}</span>
                                </div>
                            </div>
                            <div class="mt-2 text-sm text-gray-600">
                                Max position: $${o.up_liquidity?.toFixed(0) || '-'} / $${o.down_liquidity?.toFixed(0) || '-'}
                            </div>
                        </div>
                    `;
                } else if (data.monitor?.markets_closed) {
                    activeEl.innerHTML = `
                        <div class="text-center py-6">
                            <p class="text-orange-600 font-medium">Markets Closed</p>
                            <p class="text-gray-400 text-sm mt-1">15m crypto markets run ${data.monitor?.trading_hours || '6 PM - 12 AM EST'}</p>
                            <p class="text-gray-400 text-sm">Check back during trading hours</p>
                        </div>
                    `;
                } else {
                    activeEl.innerHTML = '<p class="text-gray-400 text-center py-8">No active opportunities - watching for combined &lt; $1.00</p>';
                }

                // Update time
                document.getElementById('last-update').textContent = 'Updated: ' + new Date().toLocaleTimeString();

            } catch (e) {
                console.error('Failed to load summary:', e);
                document.getElementById('monitor-status').innerHTML =
                    '<span class="w-3 h-3 rounded-full bg-red-500"></span><span class="text-red-500">API Error</span>';
            }
        }

        // Load live spreads
        async function loadSpreads() {
            try {
                const res = await fetch(`${API_BASE}/api/spreads`);
                const data = await res.json();

                if (data.error || !data.spreads) {
                    return;
                }

                const grid = document.getElementById('spreads-grid');

                // Group by asset
                const byAsset = {};
                data.spreads.forEach(s => {
                    if (!byAsset[s.asset]) byAsset[s.asset] = [];
                    byAsset[s.asset].push(s);
                });

                // Sort each asset by timeframe
                const assetOrder = ['BTC', 'ETH', 'SOL', 'XRP'];
                let html = '';

                assetOrder.forEach(asset => {
                    const spreads = byAsset[asset] || [];
                    if (spreads.length === 0) return;

                    // Get best spread for this asset
                    const best = spreads.reduce((a, b) =>
                        (a.spread || -999) > (b.spread || -999) ? a : b
                    );

                    const hasOpp = best.has_opportunity;
                    const spreadPct = best.spread_pct?.toFixed(2) || '0.00';
                    const colorClass = getSpreadColor(best.spread_pct || 0);

                    html += `
                        <div class="card spread-card ${hasOpp ? 'has-opportunity' : ''}">
                            <div class="flex justify-between items-center mb-2">
                                ${assetBadge(asset)}
                                <span class="text-xs text-gray-400">${best.timeframe}</span>
                            </div>
                            <div class="grid grid-cols-2 gap-2 text-sm mb-2">
                                <div>
                                    <div class="text-gray-500 text-xs">UP Ask</div>
                                    <div class="font-medium">${formatPrice(best.up_price)}</div>
                                    <div class="text-xs text-gray-400">$${best.up_liquidity?.toFixed(0) || '-'} liq</div>
                                </div>
                                <div>
                                    <div class="text-gray-500 text-xs">DOWN Ask</div>
                                    <div class="font-medium">${formatPrice(best.down_price)}</div>
                                    <div class="text-xs text-gray-400">$${best.down_liquidity?.toFixed(0) || '-'} liq</div>
                                </div>
                            </div>
                            <div class="border-t pt-2">
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-500 text-xs">Combined</span>
                                    <span class="font-bold ${hasOpp ? 'text-green-600' : ''}">${formatPrice(best.combined)}</span>
                                </div>
                                <div class="flex justify-between items-center mt-1">
                                    <span class="text-gray-500 text-xs">Spread</span>
                                    <span class="font-bold ${colorClass}">${spreadPct}%</span>
                                </div>
                                <div class="flex justify-between items-center mt-1">
                                    <span class="text-gray-500 text-xs">Max Trade</span>
                                    <span class="text-xs text-gray-600">$${best.max_position?.toFixed(0) || '-'}</span>
                                </div>
                            </div>
                        </div>
                    `;
                });

                if (html) {
                    grid.innerHTML = html;
                } else {
                    grid.innerHTML = '<div class="card text-center col-span-4"><p class="text-orange-600 font-medium">Markets Closed</p><p class="text-gray-400 text-sm mt-1">Polymarket 5m/15m crypto markets run 6:15 PM - 1:15 AM EST</p></div>';
                }

            } catch (e) {
                console.error('Failed to load spreads:', e);
            }
        }

        // Load recent opportunities
        async function loadOpportunities() {
            try {
                const res = await fetch(`${API_BASE}/api/opportunities?hours=24&limit=50`);
                const data = await res.json();

                const tbody = document.getElementById('opportunities-table');

                if (!data.opportunities || data.opportunities.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center py-8 text-gray-400">No opportunities detected yet</td></tr>';
                    return;
                }

                tbody.innerHTML = data.opportunities.map(o => `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="px-4 py-2">${formatTime(o.detected_at)}</td>
                        <td class="px-4 py-2">${assetBadge(o.asset)}</td>
                        <td class="px-4 py-2 text-right">${formatPrice(o.up_ask || o.up_price)}</td>
                        <td class="px-4 py-2 text-right">${formatPrice(o.down_ask || o.down_price)}</td>
                        <td class="px-4 py-2 text-right font-medium text-green-600">${formatPrice(o.combined)}</td>
                        <td class="px-4 py-2 text-right font-bold ${getSpreadColor(o.spread_pct)}">${o.spread_pct?.toFixed(2) || '-'}%</td>
                        <td class="px-4 py-2 text-right">${formatDuration(o.duration_seconds)}</td>
                        <td class="px-4 py-2 text-right">$${o.max_position?.toFixed(0) || '-'}</td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error('Failed to load opportunities:', e);
            }
        }

        // Load hourly chart
        async function loadHourlyChart() {
            try {
                const res = await fetch(`${API_BASE}/api/stats/hourly?hours=24`);
                const data = await res.json();

                if (!data.hourly || data.hourly.length === 0) {
                    return;
                }

                const ctx = document.getElementById('hourly-chart').getContext('2d');

                if (hourlyChart) {
                    hourlyChart.destroy();
                }

                const labels = data.hourly.map(h => {
                    const date = new Date(h.hour);
                    return date.getHours() + ':00';
                });
                const counts = data.hourly.map(h => h.count);
                const maxSpreads = data.hourly.map(h => h.max_spread_pct);

                hourlyChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Opportunities',
                            data: counts,
                            backgroundColor: 'rgba(34, 197, 94, 0.6)',
                            borderColor: 'rgb(34, 197, 94)',
                            borderWidth: 1,
                            yAxisID: 'y'
                        }, {
                            label: 'Max Spread %',
                            data: maxSpreads,
                            type: 'line',
                            borderColor: 'rgb(59, 130, 246)',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            yAxisID: 'y1'
                        }]
                    },
                    options: {
                        responsive: true,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Count'
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                beginAtZero: true,
                                grid: {
                                    drawOnChartArea: false,
                                },
                                title: {
                                    display: true,
                                    text: 'Max Spread %'
                                }
                            }
                        }
                    }
                });
            } catch (e) {
                console.error('Failed to load hourly chart:', e);
            }
        }

        // Refresh all data
        async function refreshData() {
            await Promise.all([
                loadSummary(),
                loadSpreads(),
                loadOpportunities(),
                loadHourlyChart()
            ]);
        }

        // Initial load
        refreshData();

        // Auto-refresh every 1 second for real-time WebSocket data
        setInterval(() => {
            loadSpreads();
            loadSummary();
        }, 1000);

        // Refresh opportunities and chart every 10 seconds
        setInterval(() => {
            loadOpportunities();
            loadHourlyChart();
        }, 10000);
    </script>
</body>
</html>
