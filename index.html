<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Polymarket Arbitrage Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .card {
            @apply bg-white rounded-lg shadow-md p-6;
        }
        .stat-value {
            @apply text-3xl font-bold text-gray-800;
        }
        .stat-label {
            @apply text-sm text-gray-500 uppercase tracking-wide;
        }
        .badge-btc { @apply bg-orange-100 text-orange-800; }
        .badge-eth { @apply bg-blue-100 text-blue-800; }
        .badge-xrp { @apply bg-gray-100 text-gray-800; }
        .badge-sol { @apply bg-purple-100 text-purple-800; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">Polymarket Arbitrage Dashboard</h1>
                <p class="text-gray-500" id="last-update">Loading...</p>
            </div>
            <div class="flex items-center gap-4">
                <div id="collector-status" class="flex items-center gap-2">
                    <span class="w-3 h-3 rounded-full bg-gray-400"></span>
                    <span class="text-gray-500">Unknown</span>
                </div>
                <button onclick="refreshData()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">
                    Refresh
                </button>
            </div>
        </div>

        <!-- Stats Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="card">
                <div class="stat-label">Total Ticks</div>
                <div class="stat-value" id="stat-ticks">-</div>
            </div>
            <div class="card">
                <div class="stat-label">Arbitrage Opportunities</div>
                <div class="stat-value text-green-600" id="stat-opportunities">-</div>
            </div>
            <div class="card">
                <div class="stat-label">Cheap Prices (&lt;$0.45)</div>
                <div class="stat-value text-blue-600" id="stat-cheap">-</div>
            </div>
            <div class="card">
                <div class="stat-label">Completed Sessions</div>
                <div class="stat-value" id="stat-sessions">-</div>
            </div>
        </div>

        <!-- Pattern Analysis -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div class="card">
                <h2 class="text-xl font-semibold mb-4">Open/Close Patterns</h2>
                <div class="grid grid-cols-2 gap-4">
                    <div class="text-center p-4 bg-green-50 rounded-lg">
                        <div class="text-2xl font-bold text-green-600" id="yes-up-pct">-</div>
                        <div class="text-sm text-gray-600">YES Closed Above Open</div>
                    </div>
                    <div class="text-center p-4 bg-red-50 rounded-lg">
                        <div class="text-2xl font-bold text-red-600" id="no-down-pct">-</div>
                        <div class="text-sm text-gray-600">NO Closed Below Open</div>
                    </div>
                </div>
                <p class="text-sm text-gray-500 mt-4">Based on <span id="sessions-analyzed">0</span> analyzed sessions</p>
            </div>
            <div class="card">
                <h2 class="text-xl font-semibold mb-4">Arbitrage Over Time</h2>
                <canvas id="arbitrage-chart" height="150"></canvas>
            </div>
        </div>

        <!-- Tabs -->
        <div class="card">
            <div class="flex border-b mb-4">
                <button class="tab-btn active px-4 py-2 border-b-2 border-blue-500 text-blue-600" data-tab="opportunities">
                    Opportunities
                </button>
                <button class="tab-btn px-4 py-2 text-gray-500 hover:text-gray-700" data-tab="cheap">
                    Cheap Prices
                </button>
                <button class="tab-btn px-4 py-2 text-gray-500 hover:text-gray-700" data-tab="sessions">
                    Sessions
                </button>
                <button class="tab-btn px-4 py-2 text-gray-500 hover:text-gray-700" data-tab="ticks">
                    Recent Ticks
                </button>
            </div>

            <!-- Opportunities Tab -->
            <div id="tab-opportunities" class="tab-content">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left">Time</th>
                                <th class="px-4 py-2 text-left">Asset</th>
                                <th class="px-4 py-2 text-right">YES</th>
                                <th class="px-4 py-2 text-right">NO</th>
                                <th class="px-4 py-2 text-right">Combined</th>
                                <th class="px-4 py-2 text-right">Profit %</th>
                                <th class="px-4 py-2 text-right">Max Profit</th>
                            </tr>
                        </thead>
                        <tbody id="opportunities-table"></tbody>
                    </table>
                </div>
            </div>

            <!-- Cheap Prices Tab -->
            <div id="tab-cheap" class="tab-content hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left">Time</th>
                                <th class="px-4 py-2 text-left">Asset</th>
                                <th class="px-4 py-2 text-left">Side</th>
                                <th class="px-4 py-2 text-right">Price</th>
                                <th class="px-4 py-2 text-right">Liquidity</th>
                            </tr>
                        </thead>
                        <tbody id="cheap-table"></tbody>
                    </table>
                </div>
            </div>

            <!-- Sessions Tab -->
            <div id="tab-sessions" class="tab-content hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left">Close Time</th>
                                <th class="px-4 py-2 text-left">Asset</th>
                                <th class="px-4 py-2 text-right">YES Open</th>
                                <th class="px-4 py-2 text-right">YES Close</th>
                                <th class="px-4 py-2 text-center">YES Up?</th>
                                <th class="px-4 py-2 text-right">NO Open</th>
                                <th class="px-4 py-2 text-right">NO Close</th>
                                <th class="px-4 py-2 text-center">NO Down?</th>
                                <th class="px-4 py-2 text-right">Obs</th>
                            </tr>
                        </thead>
                        <tbody id="sessions-table"></tbody>
                    </table>
                </div>
            </div>

            <!-- Ticks Tab -->
            <div id="tab-ticks" class="tab-content hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left">Time</th>
                                <th class="px-4 py-2 text-left">Asset</th>
                                <th class="px-4 py-2 text-right">YES</th>
                                <th class="px-4 py-2 text-right">NO</th>
                                <th class="px-4 py-2 text-right">Combined</th>
                                <th class="px-4 py-2 text-center">Arb?</th>
                            </tr>
                        </thead>
                        <tbody id="ticks-table"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Backend API URL
        const API_BASE = window.location.hostname === 'localhost'
            ? 'http://localhost:8000'
            : 'https://polybot-misc.up.railway.app';
        let arbitrageChart = null;

        // Format timestamp
        function formatTime(isoString) {
            if (!isoString) return '-';
            const date = new Date(isoString);
            return date.toLocaleTimeString();
        }

        // Format price
        function formatPrice(price) {
            if (price === null || price === undefined) return '-';
            return '$' + price.toFixed(2);
        }

        // Get asset badge class
        function assetBadge(asset) {
            const classes = {
                'BTC': 'badge-btc',
                'ETH': 'badge-eth',
                'XRP': 'badge-xrp',
                'SOL': 'badge-sol'
            };
            return `<span class="px-2 py-1 rounded text-xs font-medium ${classes[asset] || 'bg-gray-100'}">${asset}</span>`;
        }

        // Load stats
        async function loadStats() {
            try {
                const res = await fetch(`${API_BASE}/api/stats`);
                const data = await res.json();

                document.getElementById('stat-ticks').textContent = data.total_ticks.toLocaleString();
                document.getElementById('stat-opportunities').textContent = data.total_opportunities.toLocaleString();
                document.getElementById('stat-cheap').textContent = data.total_cheap_prices.toLocaleString();
                document.getElementById('stat-sessions').textContent = data.total_sessions.toLocaleString();

                document.getElementById('yes-up-pct').textContent = data.yes_up_pct + '%';
                document.getElementById('no-down-pct').textContent = data.no_down_pct + '%';
                document.getElementById('sessions-analyzed').textContent = data.sessions_analyzed;

                // Collector status
                const statusEl = document.getElementById('collector-status');
                if (data.collector_running) {
                    statusEl.innerHTML = '<span class="w-3 h-3 rounded-full bg-green-500 animate-pulse"></span><span class="text-green-600">Running</span>';
                } else {
                    statusEl.innerHTML = '<span class="w-3 h-3 rounded-full bg-gray-400"></span><span class="text-gray-500">Stopped</span>';
                }

                // Last update
                if (data.last_tick) {
                    document.getElementById('last-update').textContent = 'Last tick: ' + formatTime(data.last_tick);
                }
            } catch (e) {
                console.error('Failed to load stats:', e);
            }
        }

        // Load opportunities
        async function loadOpportunities() {
            try {
                const res = await fetch(`${API_BASE}/api/opportunities?limit=50`);
                const data = await res.json();

                const tbody = document.getElementById('opportunities-table');
                tbody.innerHTML = data.map(o => `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="px-4 py-2">${formatTime(o.timestamp)}</td>
                        <td class="px-4 py-2">${assetBadge(o.asset)}</td>
                        <td class="px-4 py-2 text-right">${formatPrice(o.yes_ask)}</td>
                        <td class="px-4 py-2 text-right">${formatPrice(o.no_ask)}</td>
                        <td class="px-4 py-2 text-right font-medium">${formatPrice(o.combined_cost)}</td>
                        <td class="px-4 py-2 text-right text-green-600 font-medium">${o.profit_pct}%</td>
                        <td class="px-4 py-2 text-right">${formatPrice(o.max_profit_usd)}</td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error('Failed to load opportunities:', e);
            }
        }

        // Load cheap prices
        async function loadCheapPrices() {
            try {
                const res = await fetch(`${API_BASE}/api/cheap-prices?limit=50`);
                const data = await res.json();

                const tbody = document.getElementById('cheap-table');
                tbody.innerHTML = data.map(p => `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="px-4 py-2">${formatTime(p.timestamp)}</td>
                        <td class="px-4 py-2">${assetBadge(p.asset)}</td>
                        <td class="px-4 py-2"><span class="px-2 py-1 rounded text-xs ${p.side === 'YES' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${p.side}</span></td>
                        <td class="px-4 py-2 text-right font-medium text-blue-600">${formatPrice(p.price)}</td>
                        <td class="px-4 py-2 text-right">${p.liquidity?.toFixed(2) || '-'}</td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error('Failed to load cheap prices:', e);
            }
        }

        // Load sessions
        async function loadSessions() {
            try {
                const res = await fetch(`${API_BASE}/api/sessions?limit=50`);
                const data = await res.json();

                const tbody = document.getElementById('sessions-table');
                tbody.innerHTML = data.map(s => `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="px-4 py-2">${formatTime(s.close_time)}</td>
                        <td class="px-4 py-2">${assetBadge(s.asset)}</td>
                        <td class="px-4 py-2 text-right">${formatPrice(s.yes_open)}</td>
                        <td class="px-4 py-2 text-right">${formatPrice(s.yes_close)}</td>
                        <td class="px-4 py-2 text-center">${s.yes_closed_above_open ? '<span class="text-green-600">✓</span>' : '<span class="text-red-600">✗</span>'}</td>
                        <td class="px-4 py-2 text-right">${formatPrice(s.no_open)}</td>
                        <td class="px-4 py-2 text-right">${formatPrice(s.no_close)}</td>
                        <td class="px-4 py-2 text-center">${s.no_closed_below_open ? '<span class="text-green-600">✓</span>' : '<span class="text-red-600">✗</span>'}</td>
                        <td class="px-4 py-2 text-right">${s.observation_count}</td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error('Failed to load sessions:', e);
            }
        }

        // Load ticks
        async function loadTicks() {
            try {
                const res = await fetch(`${API_BASE}/api/ticks?limit=100`);
                const data = await res.json();

                const tbody = document.getElementById('ticks-table');
                tbody.innerHTML = data.map(t => `
                    <tr class="border-b hover:bg-gray-50 ${t.has_arbitrage ? 'bg-green-50' : ''}">
                        <td class="px-4 py-2">${formatTime(t.timestamp)}</td>
                        <td class="px-4 py-2">${assetBadge(t.asset)}</td>
                        <td class="px-4 py-2 text-right">${formatPrice(t.yes_ask)}</td>
                        <td class="px-4 py-2 text-right">${formatPrice(t.no_ask)}</td>
                        <td class="px-4 py-2 text-right font-medium">${formatPrice(t.combined_cost)}</td>
                        <td class="px-4 py-2 text-center">${t.has_arbitrage ? '<span class="text-green-600 font-bold">YES</span>' : '-'}</td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error('Failed to load ticks:', e);
            }
        }

        // Load arbitrage chart
        async function loadArbitrageChart() {
            try {
                const res = await fetch(`${API_BASE}/api/charts/arbitrage-over-time?hours=24`);
                const data = await res.json();

                const ctx = document.getElementById('arbitrage-chart').getContext('2d');

                if (arbitrageChart) {
                    arbitrageChart.destroy();
                }

                // Group by hour
                const hourly = {};
                data.forEach(o => {
                    const hour = new Date(o.timestamp).getHours();
                    if (!hourly[hour]) hourly[hour] = [];
                    hourly[hour].push(o.profit_pct);
                });

                const labels = Object.keys(hourly).sort((a, b) => a - b);
                const values = labels.map(h => hourly[h].length);

                arbitrageChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels.map(h => h + ':00'),
                        datasets: [{
                            label: 'Opportunities',
                            data: values,
                            backgroundColor: 'rgba(34, 197, 94, 0.6)',
                            borderColor: 'rgb(34, 197, 94)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            } catch (e) {
                console.error('Failed to load chart:', e);
            }
        }

        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => {
                    b.classList.remove('active', 'border-blue-500', 'text-blue-600');
                    b.classList.add('text-gray-500');
                });
                btn.classList.add('active', 'border-blue-500', 'text-blue-600');
                btn.classList.remove('text-gray-500');

                document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                document.getElementById('tab-' + btn.dataset.tab).classList.remove('hidden');
            });
        });

        // Refresh all data
        async function refreshData() {
            await Promise.all([
                loadStats(),
                loadOpportunities(),
                loadCheapPrices(),
                loadSessions(),
                loadTicks(),
                loadArbitrageChart()
            ]);
        }

        // Initial load
        refreshData();

        // Auto-refresh every 30 seconds
        setInterval(refreshData, 30000);
    </script>
</body>
</html>
